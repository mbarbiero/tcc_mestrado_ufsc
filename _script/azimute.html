<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SuperCIATA - Comparativo de Ajuste</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'monospace'; }
        #map { height: 100vh; width: 100vw; background: #e0e0e0; }

        .floating-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 450px;
            border-left: 8px solid #1a73e8;
            font-size: 1.2em;
        }

        .coord-box { 
            background: #f1f3f4; padding: 12px; margin-top: 15px; 
            border-radius: 4px; font-size: 1.1em; line-height: 1.6; 
        }
        
        .label-red { color: #d93025; font-weight: bold; }
        .label-blue { color: #1a73e8; font-weight: bold; }
        .label-green { color: #2e7d32; font-weight: bold; }
        .label-black { color: #202124; font-weight: bold; }
        
        button { font-size: 1em; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="floating-panel">
    <strong style="font-family: sans-serif; font-size: 1.3em;">Análise de Azimute - Rua Caramurus</strong>
    <div id="status" style="margin-top: 5px;">Buscando dados no OSM...</div>
    <div class="coord-box" id="coords-display">Aguardando coordenadas...</div>
    <div style="font-size: 0.8em; margin-top: 10px;">
        <span style="color: green;">-- Reta Vertical (Original)</span><br>
        <span style="color: blue;">— Reta Ajustada (Calculada)</span>
    </div>
    <button style="margin-top:15px; width:100%; cursor:pointer;" onclick="exportarJSON()">Baixar JSON Completo</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let dadosJSON = null;
    const centroide = [-25.68085, -53.80136];
    
    const map = L.map('map', { maxZoom: 21, zoomControl: true }).setView(centroide, 20);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 21, maxNativeZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    L.circleMarker(centroide, { color: 'black', radius: 6, fillOpacity: 1 }).addTo(map);

    // --- LINHA VERTICAL (Antes do Ajuste) ---
    const offsetRef = 0.0003;
    const linhaVertical = [
        [centroide[0] - offsetRef, centroide[1]],
        [centroide[0] + offsetRef, centroide[1]]
    ];
    L.polyline(linhaVertical, {color: 'green', weight: 3, dashArray: '10, 10', opacity: 0.7}).addTo(map);

    function selecionarSegmento(vertices, centroide) {
        let p1 = null, p2 = null;
        let menorSomaDist = Infinity;
        for (let i = 0; i < vertices.length - 1; i++) {
            const vA = vertices[i], vB = vertices[i + 1];
            const dA = Math.sqrt(Math.pow(centroide[0] - vA.lat, 2) + Math.pow(centroide[1] - vA.lon, 2));
            const dB = Math.sqrt(Math.pow(centroide[0] - vB.lat, 2) + Math.pow(centroide[1] - vB.lon, 2));
            if (dA + dB < menorSomaDist) {
                menorSomaDist = dA + dB;
                p1 = vA; p2 = vB;
            }
        }
        return { p1, p2 };
    }

    function calcularAzimute(lat1, lon1, lat2, lon2) {
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
        const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                  Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }

    async function carregarGeometria() {
        const query = `[out:json];way["name"~"Caramurus"](around:30, ${centroide[0]}, ${centroide[1]});out geom;`;
        try {
            const response = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
            dadosJSON = await response.json();
            
            if (dadosJSON.elements.length > 0) {
                const via = dadosJSON.elements[0].geometry;
                const seg = selecionarSegmento(via, centroide);
                const az = calcularAzimute(seg.p1.lat, seg.p1.lon, seg.p2.lat, seg.p2.lon);

                document.getElementById('coords-display').innerHTML = `
                    <span class="label-black">● Centroide:</span> ${centroide[0].toFixed(6)}, ${centroide[1].toFixed(6)}<br><br>
                    <span class="label-red">■ P1:</span> ${seg.p1.lat.toFixed(6)}, ${seg.p1.lon.toFixed(6)}<br>
                    <span class="label-red">■ P2:</span> ${seg.p2.lat.toFixed(6)}, ${seg.p2.lon.toFixed(6)}<br><hr>
                    <span class="label-blue">➤ Azimute:</span> ${az.toFixed(4)}°
                `;

                L.circleMarker([seg.p1.lat, seg.p1.lon], {color: 'red', radius: 5}).addTo(map);
                L.circleMarker([seg.p2.lat, seg.p2.lon], {color: 'red', radius: 5}).addTo(map);

                const rad = (90 - az) * Math.PI / 180;
                const d = 0.0003;
                const linhaAjustada = [
                    [centroide[0] - Math.sin(rad)*d, centroide[1] - Math.cos(rad)*d],
                    [centroide[0] + Math.sin(rad)*d, centroide[1] + Math.cos(rad)*d]
                ];
                L.polyline(linhaAjustada, {color: 'blue', weight: 5}).addTo(map);
                document.getElementById('status').innerText = "Dados carregados.";
            }
        } catch (e) { document.getElementById('status').innerText = "Erro na API."; }
    }

    function exportarJSON() {
        if (!dadosJSON) return;
        const blob = new Blob([JSON.stringify(dadosJSON, null, 2)], { type: "application/json" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `superciata_caramurus.json`;
        a.click();
    }

    carregarGeometria();
</script>
</body>
</html>