<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>SuperCIATA - Extrator OSM v04</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #input-area { width: 950px; background: #2c3e50; padding: 20px; border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        textarea { width: 100%; height: 120px; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; border: none; box-sizing: border-box; color: #333; }
        .btn-main { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; transition: 0.3s; }
        .btn-main:hover { background: #219150; }
        #dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 15px; width: 98%; margin-top: 10px; flex-grow: 1; margin-bottom: 20px; }
        #status-container { background: #2c3e50; padding: 15px; border-radius: 8px; overflow-y: auto; max-height: 700px; border: 1px solid #444; }
        #map { background: #ddd; border-radius: 8px; height: 700px; border: 2px solid #27ae60; }
        .FACE-card { background: #34495e; padding: 12px; border-radius: 5px; margin-bottom: 10px; border-left: 6px solid #7f8c8d; font-size: 12px; }
        .found { border-left-color: #27ae60; }
        .not-found { border-left-color: #e74c3c; }
        .label-id { display: block; color: #f39c12; font-weight: bold; font-size: 10px; }
    </style>
</head>

<body>

    <div id="input-area">
        <h2 style="margin:0 0 10px 0; color: #27ae60;">SuperCIATA - Extrator Resiliente v04</h2>
        <textarea id="json-input" placeholder='Cole o JSON das quadras aqui...'></textarea>
        <button class="btn-main" onclick="processarEExportar()">INICIAR BUSCA (TRATAMENTO DE PISTAS DUPLAS)</button>
    </div>

    <div id="dashboard" style="display:none;">
        <div id="status-container"></div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;

        function salvarJSON(objeto, nomeArquivo) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(objeto, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", nomeArquivo + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function formatarWKT(geometry) {
            if (!geometry) return "";
            const coords = geometry.map(p => `${p.lon} ${p.lat}`).join(", ");
            return `LINESTRING (${coords})`;
        }

        // FUNÇÃO CRUCIAL: Limpa "AV.", "RUA", "R." e pontos para a busca ser ampla
        function limparNomeParaBusca(nome) {
            return nome.toUpperCase()
                .replace(/AV\.|AVENIDA|RUA|R\.|DR\.|PROFR\./g, "")
                .replace(/\./g, "")
                .trim();
        }

        async function processarEExportar() {
            const input = document.getElementById('json-input').value;
            if (!input) return;

            let dadosQuadras;
            try {
                dadosQuadras = JSON.parse(input);
            } catch (e) {
                alert("Erro no JSON.");
                return;
            }

            const container = document.getElementById('status-container');
            document.getElementById('dashboard').style.display = 'grid';
            container.innerHTML = "<b>Iniciando processamento...</b><hr>";

            if (map) map.remove();
            const pRef = dadosQuadras[0].FACES[0].CENTROIDE;
            map = L.map('map').setView([pRef[0], pRef[1]], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            for (let quadra of dadosQuadras) {
                for (let face of quadra.FACES) {
                    const nomeOriginal = face.CI_NOM_LOGRADOURO;
                    const nomeBusca = limparNomeParaBusca(nomeOriginal);
                    const lat = face.CENTROIDE[0];
                    const lng = face.CENTROIDE[1];

                    // Query Overpass: Busca pelo nome limpo (Ex: "PARANA") com case-insensitive
                    // Aumentamos o raio para 400m para captar pistas duplas distantes
                    const query = `[out:json];way["name"~"${nomeBusca}",i](around:400,${lat},${lng});out geom;`;

                    try {
                        const res = await fetch("https://overpass-api.de/api/interpreter", {
                            method: "POST",
                            body: query
                        });
                        const osm = await res.json();

                        if (osm.elements && osm.elements.length > 0) {
                            osm.elements.forEach((via) => {
                                const exportData = {
                                    CI_ID_QUADRA: quadra.CI_ID_QUADRA,
                                    SC_ID_LOGRADOURO: face.SC_ID_LOGRADOURO,
                                    NOM_ORIGINAL: nomeOriginal,
                                    NOM_OSM: via.tags.name,
                                    OSM_ID: via.id,
                                    WKT: formatarWKT(via.geometry),
                                    CENTROIDE_FACE: { lat, lng }
                                };

                                const nomeArq = `${nomeBusca}_${face.SC_ID_LOGRADOURO}_${via.id}`;
                                salvarJSON(exportData, nomeArq);

                                L.polyline(via.geometry.map(p => [p.lat, p.lon]), { color: '#27ae60', weight: 5 }).addTo(map)
                                 .bindPopup(`Busca: ${nomeBusca}<br>OSM: ${via.tags.name}`);
                            });

                            container.innerHTML += `
                                <div class="FACE-card found">
                                    <span class="label-id">${quadra.CI_ID_QUADRA}</span>
                                    <b>${nomeOriginal}</b><br>
                                    <small>Encontradas ${osm.elements.length} geometrias (incluindo pistas duplas).</small>
                                </div>`;
                        } else {
                            container.innerHTML += `
                                <div class="FACE-card not-found">
                                    <b>${nomeOriginal}</b><br>
                                    <small>Sem resultados para "${nomeBusca}" em 400m.</small>
                                </div>`;
                        }
                    } catch (err) { console.error(err); }
                    await new Promise(r => setTimeout(r, 1300));
                }
            }
        }
    </script>
</body>
</html>