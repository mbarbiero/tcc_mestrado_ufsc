<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SC_ Precisão Máxima - GeoJSON Cadurb</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #f4f4f4; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #map-container { width: 90%; height: 90vh; position: relative; border: 2px solid #ccc; box-shadow: 0 10px 30px rgba(0,0,0,0.2); background: white; }
        #map { width: 100%; height: 100%; }
        .info-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1001;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 4px; border-left: 5px solid #28a745; width: 320px;
        }
        .stats { font-size: 11px; margin-top: 10px; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; }
        input[type="file"] { font-size: 11px; width: 100%; margin-top: 10px; }
        .leaflet-popup-content { font-size: 12px; font-family: monospace; }
    </style>
</head>
<body>

<div id="map-container">
    <div class="info-panel">
        <h2 style="font-size: 14px; margin: 0; color: #28a745;">SC_ Renderizador de Precisão</h2>
        <p style="font-size: 11px; color: #666;">Origem: Campo <b>lotes_urbanos.geojson</b></p>
        
        <input type="file" id="csvFile" accept=".csv">
        
        <div id="stats" class="stats">Aguardando upload do CSV...</div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    // Inicializa o mapa focado em Capanema
    const map = L.map('map', { 
        zoomControl: true, 
        attributionControl: false,
        preferCanvas: true // Melhora a performance e precisão de renderização para muitos lotes
    }).setView([-25.6807, -53.8018], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let geojsonLayer = L.geoJSON(null, {
        style: {
            color: "#28a745",
            weight: 1.5,
            fillOpacity: 0.3,
            fillColor: "#28a745"
        },
        onEachFeature: function (feature, layer) {
            let popupContent = "<b>LOTE DETALHADO</b><br><hr>";
            if (feature.properties) {
                // Adiciona todas as propriedades disponíveis no GeoJSON para o popup
                for (let key in feature.properties) {
                    popupContent += `<b>${key}:</b> ${feature.properties[key]}<br>`;
                }
            }
            layer.bindPopup(popupContent);
        }
    }).addTo(map);

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('stats').innerHTML = "Lendo e limpando dados...";

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                geojsonLayer.clearLayers();
                let sucessos = 0;
                let falhas = 0;

                results.data.forEach((row, index) => {
                    // O campo GeoJSON no CSV geralmente vem como string com aspas duplicadas escapadas
                    let rawGeoJSON = row['lotes_urbanos.geojson'];

                    if (rawGeoJSON) {
                        try {
                            // 1. Limpa as aspas duplicadas do formato CSV ("" -> ")
                            // 2. Remove aspas externas se existirem
                            let cleanedJSON = rawGeoJSON.toString()
                                .replace(/""/g, '"') 
                                .replace(/^"/, '')
                                .replace(/"$/, '');

                            const parsed = JSON.parse(cleanedJSON);
                            
                            // Adiciona ao mapa mantendo a precisão flutuante original
                            geojsonLayer.addData(parsed);
                            sucessos++;
                        } catch (err) {
                            falhas++;
                            if (index === 0) console.error("Erro no primeiro parse:", err, rawGeoJSON);
                        }
                    }
                });

                if (sucessos > 0) {
                    const bounds = geojsonLayer.getBounds();
                    map.fitBounds(bounds);
                    document.getElementById('stats').innerHTML = `
                        <b>Resultado:</b><br>
                        ✅ ${sucessos} geometrias renderizadas<br>
                        ❌ ${falhas} falhas (formato inválido)
                    `;
                } else {
                    document.getElementById('stats').innerHTML = "<b>Erro:</b> Não foi possível extrair GeoJSON válido.";
                }
            }
        });
    });
</script>
</body>
</html>