<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SuperCIATA - Geoprocessamento de Quadra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { 
            margin: 0; padding: 0; 
            background-color: #f4f4f4; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Segoe UI', sans-serif; 
        }

        #map-container {
            width: 800px; height: 600px;
            position: relative;
            border: 2px solid #ccc;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: #e0e0e0; /* Fundo cinza caso o tile demore */
        }

        #map { width: 100%; height: 100%; }
        
        .info-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1001;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 4px;
            border-left: 5px solid #e91e63;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-panel h2 { margin: 0 0 5px 0; font-size: 14px; color: #333; text-transform: uppercase; }
        .info-panel p { margin: 3px 0; font-size: 11px; color: #555; font-family: monospace; }
        
        .btn-export {
            margin-top: 10px; width: 100%; padding: 6px;
            background: #e91e63; color: white; border: none;
            border-radius: 3px; cursor: pointer; font-size: 10px; font-weight: bold;
        }

        .edge-label {
            background: #e91e63; color: #fff; padding: 2px 5px;
            border-radius: 3px; font-size: 10px; font-weight: bold;
            white-space: nowrap; text-align: center;
        }
    </style>
</head>
<body>

<div id="map-container">
    <div class="info-panel">
        <h2>Domínio SC - Quadra Geo</h2>
        <div id="vertex-list"></div>
        <button class="btn-export" onclick="exportarJSON()">Exportar JSON</button>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const centroMapa = [-25.68070, -53.80205];
    const corRosaSC = "#e91e63";

    // Inicialização do Mapa
    const map = L.map('map', { 
        maxZoom: 19,
        minZoom: 19,
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        touchZoom: false,
        attributionControl: false
    }).setView(centroMapa, 19);

    // Camada OSM (Garante o carregamento)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Forçar o Leaflet a recalcular o tamanho do mapa após o carregamento
    setTimeout(() => { map.invalidateSize(); }, 200);

    const verticesRaw = [
        { id: "V1", lat: -25.681089, lng: -53.802463 },
        { id: "V2", lat: -25.680133, lng: -53.802173 },
        { id: "V3", lat: -25.680372, lng: -53.801213 },
        { id: "V4", lat: -25.681329, lng: -53.801503 }
    ];

    const quadrilatero = verticesRaw.map(v => ({
        id: v.id,
        lat: parseFloat(v.lat.toFixed(5)),
        lng: parseFloat(v.lng.toFixed(5))
    }));

    function init() {
        let htmlList = "";
        const pontosParaPoligono = quadrilatero.map(v => [v.lat, v.lng]);

        L.polygon(pontosParaPoligono, {
            color: corRosaSC,
            fillColor: corRosaSC,
            fillOpacity: 0.25,
            weight: 4
        }).addTo(map);

        quadrilatero.forEach((v, i) => {
            const p1 = L.latLng(v.lat, v.lng);
            const proximo = quadrilatero[(i + 1) % quadrilatero.length];
            const p2 = L.latLng(proximo.lat, proximo.lng);
            
            const dist = p1.distanceTo(p2);
            const mid = [ (p1.lat + p2.lat)/2, (p1.lng + p2.lng)/2 ];

            L.circleMarker(p1, { radius: 5, color: corRosaSC, fillOpacity: 1 }).addTo(map);

            L.marker(mid, {
                icon: L.divIcon({
                    className: 'edge-label',
                    html: `${dist.toFixed(2)}m`,
                    iconSize: [50, 16]
                })
            }).addTo(map);

            htmlList += `<p><b>${v.id}:</b> ${v.lat.toFixed(5)}, ${v.lng.toFixed(5)}</p>`;
        });

        document.getElementById('vertex-list').innerHTML = htmlList;
    }

    function exportarJSON() {
        const data = JSON.stringify(quadrilatero, null, 2);
        const blob = new Blob([data], {type: "application/json"});
        window.open(URL.createObjectURL(blob));
    }

    init();
</script>
</body>
</html>