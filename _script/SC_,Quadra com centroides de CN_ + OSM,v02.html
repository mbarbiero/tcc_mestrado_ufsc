<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>SC_ Quadra Centralizada e Ajustada</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0; padding: 0; background-color: #f4f4f4;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        #map-container {
            width: 800px; height: 600px; position: relative;
            border: 2px solid #ccc; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: white; overflow: hidden;
        }
        #map { width: 100%; height: 100%; }
        .info-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1001;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 4px; border-left: 5px solid #007bff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); width: 300px;
        }
        .info-panel h2 { margin: 0 0 5px 0; font-size: 14px; color: #333; text-transform: uppercase; }
        .info-panel p { margin: 3px 0; font-size: 11px; color: #555; }
        .coords-list {
            background: #f8f9fa; padding: 8px; border: 1px solid #ddd;
            margin-top: 10px; max-height: 120px; overflow-y: auto;
            font-family: monospace; font-size: 10px;
        }
        .btn-export {
            margin-top: 10px; width: 100%; padding: 8px;
            background: #007bff; color: white; border: none;
            border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="map-container">
        <div class="info-panel">
            <h2>SC_ Quadra Centralizada</h2>
            <p><strong>Município:</strong> Capanema - PR</p>
            <p><strong>Centroide Alvo:</strong> -25.6807358, -53.8018528</p>
            <p><strong>Ajuste:</strong> 15.5° (Translação por Centroide)</p>
            <div id="vertex-display" class="coords-list"></div>
            <button class="btn-export" onclick="exportarJSON()">EXPORTAR JSON AJUSTADO</button>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Coordenadas e Dimensões
        const centroideAlvo = [-25.6807358, -53.8018528];
        const dimX = 100; 
        const dimY = 110; 
        const angulo = 15.5; 

        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView(centroideAlvo, 19);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let verticesFinais = [];

        function processarGeometria() {
            const rad = (angulo * Math.PI) / 180;

            // Fatores de conversão (Capanema)
            const mLat = 111320;
            const mLon = 111320 * Math.cos(centroideAlvo[0] * Math.PI / 180);

            // 1. Criar retângulo centrado na origem (0,0) em metros
            const baseMetros = [
                { id: "V1", x: -dimX / 2, y: dimY / 2 },  // Noroeste
                { id: "V2", x: dimX / 2, y: dimY / 2 },   // Nordeste
                { id: "V3", x: dimX / 2, y: -dimY / 2 },  // Sudeste
                { id: "V4", x: -dimX / 2, y: -dimY / 2 }  // Sudoeste
            ];

            let html = "";
            verticesFinais = baseMetros.map(p => {
                // 2. Aplicar Rotação Horária
                const rx = p.x * Math.cos(rad) + p.y * Math.sin(rad);
                const ry = -p.x * Math.sin(rad) + p.y * Math.cos(rad);

                // 3. Converter para Geográficas e Transladar para o Centroide Alvo
                const lat = parseFloat((centroideAlvo[0] + (ry / mLat)).toFixed(7));
                const lng = parseFloat((centroideAlvo[1] + (rx / mLon)).toFixed(7));

                html += `<b>${p.id}:</b> ${lat}, ${lng}<br>`;
                return { id: p.id, lat, lng };
            });

            document.getElementById('vertex-display').innerHTML = html;

            // Desenhar Polígono
            const pts = verticesFinais.map(v => [v.lat, v.lng]);
            L.polygon(pts, { color: '#007bff', weight: 3, fillOpacity: 0.2 }).addTo(map);

            // Ponto central de confirmação
            L.circleMarker(centroideAlvo, { radius: 4, color: 'red', fillOpacity: 1 }).addTo(map)
             .bindPopup("Centroide Alvo");
        }

        function exportarJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(verticesFinais, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "sc_quadra_centralizada.json");
            dlAnchor.click();
        }

        processarGeometria();
        setTimeout(() => map.invalidateSize(), 200);
    </script>
</body>
</html>