<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SuperCIATA - Lotes com Dimens√µes e Sat√©lite</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'monospace'; }
        #map { height: 100vh; width: 100vw; background: #333; }

        .floating-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: rgba(255, 255, 255, 0.98); padding: 15px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-left: 8px solid #1a73e8; width: 350px;
        }

        .btn-export {
            background: #1a73e8; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px;
            font-weight: bold;
        }

        .lote-label {
            background: rgba(0, 0, 0, 0.5); border: 1px solid #ffff00;
            border-radius: 3px; color: #ffff00; font-weight: bold; 
            font-size: 9px; text-align: center; pointer-events: none;
            padding: 2px; white-space: nowrap;
        }

        .control-group { margin: 10px 0; font-size: 0.9em; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div class="floating-panel">
    <strong style="font-size: 1.2em;">An√°lise T√©cnica de Lotes</strong><br>
    <small>Visualiza√ß√£o de Dimens√µes Reais</small>
    
    <div class="control-group">
        <label>Ficheiro CSV:</label>
        <input type="file" id="csvFile" accept=".csv" style="font-size: 0.8em; display: block; margin-top: 5px;">
    </div>

    <div class="control-group">
        <label>Opacidade dos Lotes:</label>
        <input type="range" id="opacityRange" min="0" max="1" step="0.1" value="0.3">
    </div>

    <div id="status" style="font-size: 0.8em; color: #666;">Aguardando dados...</div>
    
    <button class="btn-export" onclick="exportarTabela()">Exportar CSV de Medidas</button>
</div>

<div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const refOriginal = [-25.68070, -53.80205];
    let dadosProcessados = [];
    let camadaPoligonos = [];

    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22, maxNativeZoom: 19 });
    const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 22, maxNativeZoom: 18 });

    const map = L.map('map', { layers: [satelite], zoomControl: true }).setView(refOriginal, 20);
    L.control.layers({ "üõ∞Ô∏è Sat√©lite": satelite, "üó∫Ô∏è Mapa": osm }).addTo(map);

    let camadaLotes = L.layerGroup().addTo(map);

    function calcularDistancia(p1, p2) {
        const R = 6371000;
        const dLat = (p2[0] - p1[0]) * Math.PI / 180;
        const dLon = (p2[1] - p1[1]) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(p1[0]*Math.PI/180)*Math.cos(p2[0]*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function analisarDimensoes(coords) {
        let distancias = [];
        for (let i = 0; i < coords.length - 1; i++) {
            distancias.push(calcularDistancia(coords[i], coords[i+1]));
        }
        distancias.sort((a, b) => b - a);
        // Assume os dois maiores lados como profundidades e os menores como testadas/fundos
        return {
            testada: distancias[distancias.length - 2] || 0,
            profundidade: distancias[0] || 0
        };
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            complete: function(res) { renderizar(res.data); }
        });
    });

    document.getElementById('opacityRange').addEventListener('input', function(e) {
        const val = e.target.value;
        camadaPoligonos.forEach(p => p.setStyle({ fillOpacity: val }));
    });

    function renderizar(dados) {
        camadaLotes.clearLayers();
        dadosProcessados = [];
        camadaPoligonos = [];

        dados.forEach(item => {
            if (!item.geometria) return;
            const rawCoords = item.geometria.match(/-?\d+\.\d+\s-?\d+\.\d+/g);
            if (!rawCoords) return;

            const coords = rawCoords.map(s => {
                const [lon, lat] = s.split(" ").map(Number);
                return [lat, lon];
            });

            const dim = analisarDimensoes(coords);
            dadosProcessados.push({
                codigo: item.codigo_cartografico,
                testada: dim.testada.toFixed(2),
                profundidade: dim.profundidade.toFixed(2)
            });

            const poly = L.polygon(coords, {
                color: '#ffff00', weight: 1.5, fillColor: '#ffff00', 
                fillOpacity: document.getElementById('opacityRange').value
            }).addTo(camadaLotes);
            camadaPoligonos.push(poly);

            const centro = [
                coords.reduce((a,b) => a + b[0], 0) / coords.length,
                coords.reduce((a,b) => a + b[1], 0) / coords.length
            ];

            // R√ìTULO COM DIMENS√ïES: Lote + (Testada x Profundidade)
            L.marker(centro, {
                icon: L.divIcon({
                    className: 'lote-label',
                    html: `L:${item.codigo_cartografico.split('.').pop()}<br>${dim.testada.toFixed(1)}x${dim.profundidade.toFixed(1)}m`,
                    iconSize: [70, 30]
                })
            }).addTo(camadaLotes);
        });

        document.getElementById('status').innerText = `${dadosProcessados.length} lotes identificados.`;
    }

    function exportarTabela() {
        if (dadosProcessados.length === 0) return alert("Sem dados!");
        let csv = "Codigo,Testada,Profundidade\n" + dadosProcessados.map(e => `${e.codigo},${e.testada},${e.profundidade}`).join("\n");
        const link = document.createElement("a");
        link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        link.download = "medicao_lotes.csv";
        link.click();
    }
</script>
</body>
</html>