<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SuperCIATA - Comparativo Geométrico Final</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'monospace'; }
        #map { height: 100vh; width: 100vw; background: #f0f0f0; }
        .floating-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 400px; border-left: 8px solid #1a73e8;
        }
        .edge-label-blue { background: #1a73e8; color: white; font-weight: bold; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; border: 1px solid white; white-space: nowrap; }
        .edge-label-orange { background: #f57c00; color: white; font-weight: bold; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; border: 1px solid white; white-space: nowrap; }
    </style>
</head>
<body>

<div class="floating-panel">
    <strong>Análise de Divergência Cadastral</strong><br>
    <small>Sobreposição: Cadastro Técnico vs Base Municipal</small>
    <div style="margin-top:8px; font-size: 0.85em;">
        <span style="color: #1a73e8;">■</span> Azul: Medidas Reais (Norte Geográfico)<br>
        <span style="color: #f57c00;">■</span> Laranja: Base SIG (Rotacionada 345°)
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Geometria da Base SIG (Laranja)
    const geoOriginal = [
        [-25.681089, -53.802463], [-25.680133, -53.802173], 
        [-25.680372, -53.801213], [-25.681329, -53.801503]
    ];

    const centroide = [
        geoOriginal.reduce((sum, p) => sum + p[0], 0) / geoOriginal.length,
        geoOriginal.reduce((sum, p) => sum + p[1], 0) / geoOriginal.length
    ];

    const map = L.map('map', { maxZoom: 22 }).setView(centroide, 20);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 22, maxNativeZoom: 19
    }).addTo(map);

    function rotacionar(lat, lon, latC, lonC, ang) {
        const rad = ang * Math.PI / 180;
        const cosL = Math.cos(latC * Math.PI / 180);
        let dy = lat - latC;
        let dx = (lon - lonC) * cosL;
        let rx = dx * Math.cos(rad) + dy * Math.sin(rad);
        let ry = -dx * Math.sin(rad) + dy * Math.cos(rad);
        return [latC + ry, lonC + (rx / cosL)];
    }

    // --- DESENHO LARANJA (ROTACIONADO 345°) ---
    const geoLaranja = geoOriginal.map(p => rotacionar(p[0], p[1], centroide[0], centroide[1], 345));
    geoLaranja.push(geoLaranja[0]);
    L.polygon(geoLaranja, { color: '#f57c00', weight: 2, fillOpacity: 0.2 }).addTo(map);

    for (let i = 0; i < 4; i++) {
        const d = L.latLng(geoLaranja[i]).distanceTo(L.latLng(geoLaranja[i+1]));
        const mid = [(geoLaranja[i][0] + geoLaranja[i+1][0])/2, (geoLaranja[i][1] + geoLaranja[i+1][1])/2];
        L.marker(mid, { icon: L.divIcon({ className: 'edge-label-orange', html: d.toFixed(1)+'m' }) }).addTo(map);
    }

    // --- DESENHO AZUL (IRREGULAR PROPORCIONAL) ---
    const degLat = 111320; 
    const degLon = degLat * Math.cos(centroide[0] * Math.PI / 180);

    // Medidas fornecidas: Norte, Leste, Sul, Oeste
    const mN = 100; const mL = 115; const mS = 100 ; const mO = 107.5;

    // Offset a partir do centroide para criar o quadrilátero irregular
    const quadAzul = [
        [centroide[0] + (mL/2)/degLat, centroide[1] - (mN/2)/degLon], // NW
        [centroide[0] + (mL/2)/degLat, centroide[1] + (mN/2)/degLon], // NE
        [centroide[0] - (mO/2)/degLat, centroide[1] + (mS/2)/degLon], // SE
        [centroide[0] - (mO/2)/degLat, centroide[1] - (mS/2)/degLon], // SW
        [centroide[0] + (mL/2)/degLat, centroide[1] - (mN/2)/degLon]  // Fechar
    ];

    L.polygon(quadAzul, { color: '#1a73e8', weight: 4, fillOpacity: 0.15 }).addTo(map);

    // Labels Azul
    const labelsAz = [mN+"m", mL+"m", mS+"m", mO+"m"];
    for (let i = 0; i < 4; i++) {
        const mid = [(quadAzul[i][0] + quadAzul[i+1][0])/2, (quadAzul[i][1] + quadAzul[i+1][1])/2];
        L.marker(mid, { icon: L.divIcon({ className: 'edge-label-blue', html: labelsAz[i] }) }).addTo(map);
    }

    // Rosa dos Ventos interna
    const compassIcon = L.divIcon({
        className: 'comp',
        html: `<svg width="50" height="50" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="38" fill="white" fill-opacity="0.8" stroke="#333"/>
                <path d="M50 12 L58 50 L50 88 L42 50 Z" fill="#d32f2f"/><path d="M50 50 L58 50 L50 88 L42 50 Z" fill="#333"/>
                <text x="44" y="28" font-weight="bold" font-size="20">N</text></svg>`,
        iconSize: [50, 50], iconAnchor: [25, 25]
    });
    L.marker(centroide, { icon: compassIcon }).addTo(map);
</script>
</body>
</html>